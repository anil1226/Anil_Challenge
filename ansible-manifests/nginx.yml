---
- hosts: all
  become: true
  tasks:
    - name: Install Nginx
      apt:
        name: nginx
        state: present

    - name: Delete file
      file:
        path: /var/www/html/index.html
        state: absent

    - name: Creating a file with content
      copy:
        dest: /var/www/html/index.html
        content: |
          <html>
          <head>
          <title>Hello World</title>
          </head>
          <body>
          <h1>Hello World!</h1>
          </body>
          </html
      notify: restart nginx

    - name: Create SSL directory for Nginx
      file:
        path: /etc/nginx/ssl
        state: directory
        mode: '0755'

    - name: Generate a private key
      openssl_privatekey:
        path: /etc/nginx/ssl/nginx.key
        size: 2048
        type: RSA

    - name: Generate a CSR
      openssl_csr:
        path: /etc/nginx/ssl/nginx.csr
        privatekey_path: /etc/nginx/ssl/nginx.key
        common_name: example.com
        organization_name: Example Company
        country_name: US
        state_or_province_name: California
        locality_name: San Francisco
        email_address: admin@example.com

    - name: Create a self-signed certificate
      openssl_certificate:
        path: /etc/nginx/ssl/nginx.crt
        csr_path: /etc/nginx/ssl/nginx.csr
        privatekey_path: /etc/nginx/ssl/nginx.key
        provider: selfsigned
        force: true

    - name: Configure Nginx default server block to use the self-signed certificate
      lineinfile:
        path: /etc/nginx/conf.d/default.conf
        regexp: ^(\s+)ssl_certificate
        line: \1ssl_certificate /etc/nginx/ssl/nginx.crt;
        create: yes
      notify: restart nginx

    - name: Configure Nginx default server block to use the private key for the self-signed certificate
      lineinfile:
        path: /etc/nginx/conf.d/default.conf
        regexp: ^(\s+)ssl_certificate_key
        line: \1ssl_certificate_key /etc/nginx/ssl/nginx.key;
      notify: restart nginx

  handlers:
    - name: restart nginx
      service:
        name: nginx
        state: restarted